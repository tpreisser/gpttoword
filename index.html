<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700&display=swap" rel="stylesheet">
    <title>R² Solutions · GPT → Word Copier</title>
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.min.js"></script>
    <style>
      :root{
        --font:'Plus Jakarta Sans',sans-serif;
        --navy:#0a041a; --blue:#3c67e3; --violet:#8b5cf6;
        --light:#e2e8f0; --panel:rgba(20,15,40,.6); --panel-bd:rgba(139,92,246,.35);
        --field-bd:rgba(139,92,246,.35); --bd:#1f2937; --backdrop:rgba(4,7,20,.72);
      }
      html,body{margin:0;padding:0;height:100%;font-family:var(--font);background:var(--navy);color:var(--light);}
      body{display:flex;justify-content:center;text-align:center}
      body::before{content:'';position:fixed;left:0;top:0;width:520px;height:520px;background:radial-gradient(circle,var(--blue),var(--violet));filter:blur(180px);opacity:.35;pointer-events:none;animation:pan 22s ease-in-out infinite alternate;z-index:0}
      @keyframes pan{from{transform:translate(-40%,-40%) scale(1)}to{transform:translate(40%,40%) scale(1.5)}}
      .main{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:1rem;padding:2rem 2rem 4rem;width:100%}
      .logo{width:min(900px,92vw);height:auto;display:block;margin:0 auto;transform:translateX(60px)}
      .sub{font-size:1.06rem;font-weight:400;max-width:900px;line-height:1.5;margin-top:.25rem;background:linear-gradient(90deg,#a7b7e8,#c6b2f8);-webkit-background-clip:text;background-clip:text;color:transparent}
      .box{margin-top:1.2rem;width:clamp(360px,92vw,1100px);background:var(--panel);border:1px solid var(--panel-bd);border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,.45);overflow:visible;display:flex;flex-direction:column;backdrop-filter:blur(10px)}
      .hdr{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1.2rem;background:linear-gradient(90deg,var(--blue),var(--violet))}
      .hdr .l{display:flex;align-items:baseline;gap:10px}
      .hdr .title{font-weight:700;color:#fff;font-size:1.15rem}
      .hdr .v{font-weight:500;color:rgba(255,255,255,.8);font-size:.86rem}
      .dots{display:flex;gap:7px}.dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,.35)}
      .body{padding:18px;display:flex;flex-direction:column;gap:14px;text-align:left}
      .md{width:100%;min-height:320px;resize:vertical;background:#0a0f1e;border:1px solid var(--field-bd);color:#e2e8f0;border-radius:12px;padding:16px;box-sizing:border-box;font-size:1.05rem;line-height:1.6;outline:none}
      .controls{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;margin-top:10px;justify-content:center}
      @media (max-width: 768px) {
        .controls{gap:.4rem}
        .btn{padding:.5rem .6rem;font-size:0.8rem;min-width:100px}
      }
      @media (max-width: 480px) {
        .controls{flex-direction:column;gap:.5rem}
        .btn{width:100%;max-width:200px}
      }
      .filename{background:#0a0f1e;border:1px solid var(--field-bd);color:#e2e8f0;border-radius:12px;padding:.75rem 1rem;min-width:260px;flex:1; display: none;} /* Filename is not needed now */
      .btn{appearance:none;border:1px solid var(--bd);background:#10192e;color:#e6faff;border-radius:12px;padding:.6rem .8rem;font-weight:800;cursor:pointer;transition:.18s;font-size:0.9rem;min-width:120px}
      .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
      .btn-primary{background:linear-gradient(135deg,var(--blue),var(--violet));border-color:var(--blue)}
      .btn-primary:hover{border-color:var(--violet);box-shadow:0 4px 12px rgba(139,92,246,.4)}
      .btn-success{background:linear-gradient(135deg,var(--blue),var(--violet));border-color:var(--blue)}
      .btn-success:hover{border-color:var(--violet);box-shadow:0 4px 12px rgba(139,92,246,.4)}
      .btn-info{background:linear-gradient(135deg,var(--blue),var(--violet));border-color:var(--blue)}
      .btn-info:hover{border-color:var(--violet);box-shadow:0 4px 12px rgba(139,92,246,.4)}
      .btn-warning{background:linear-gradient(135deg,var(--blue),var(--violet));border-color:var(--blue)}
      .btn-warning:hover{border-color:var(--violet);box-shadow:0 4px 12px rgba(139,92,246,.4)}
      .btn-secondary{background:linear-gradient(135deg,#374151,#1f2937);border-color:#374151}
      .btn-secondary:hover{border-color:#6b7280;box-shadow:0 4px 12px rgba(55,65,81,.4)}
      .backdrop{position:fixed;inset:0;background:var(--backdrop);display:none;z-index:50}
      .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(560px,92vw);background:var(--panel);border:1px solid var(--panel-bd);border-radius:20px;padding:24px;box-shadow:0 20px 50px rgba(0,0,0,.6);display:none;z-index:51;text-align:left;backdrop-filter:blur(10px);max-height:90vh;overflow-y:auto}
      .modal h3{color:#fff;font-size:1.3rem;font-weight:700;margin:0 0 20px 0;text-align:center}
      .choice{display:flex;flex-direction:column;gap:12px;margin:20px 0;max-height:300px;overflow-y:auto}
      .draglet{display:block;background:linear-gradient(90deg,var(--blue),var(--violet));color:#fff;text-decoration:none;padding:12px 16px;border-radius:12px;font-weight:600;text-align:center;transition:all .2s;border:1px solid rgba(255,255,255,.1);font-size:0.9rem}
      .draglet:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(60,103,227,.4);border-color:rgba(255,255,255,.2)}
      .actions{display:flex;justify-content:center;margin-top:24px}
      .toast{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#0a1a2e;border:1px solid #1e293b;padding:10px 14px;border-radius:10px;color:#e2f3ff;display:none;z-index:60;transition:opacity .3s}
      .loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);border:1px solid var(--panel-bd);border-radius:16px;padding:20px;box-shadow:0 20px 50px rgba(0,0,0,.6);z-index:70;display:none}
      .loading .spinner{width:40px;height:40px;border:3px solid var(--field-bd);border-top:3px solid var(--blue);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
      @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
      .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}
    </style>
</head>
<body>
  <div class="main">
    <img class="logo" src="https://drive.google.com/thumbnail?id=1E2DohDh27ZnzCyYT9hSL1aanKdLQbDla&sz=s4000" alt="R² Solutions"/>
    <p class="sub">Powered by AI · Built by R² Solutions</p>
    <div class="box">
      <div class="hdr">
        <div class="l"><span class="title">R² Solutions · GPT → Word Copier</span><span class="v">v10.1</span></div>
        <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      </div>
      <div class="body">
        <textarea id="md" class="md" placeholder="1. Use bookmarklet in ChatGPT.&#10;2. Paste here.&#10;3. Click 'Convert to Word'."></textarea>
        <div class="controls">
          <input id="filename" class="filename" type="text" value="R2 GPT Export.docx"/>
          <button onclick="pasteFromClipboard()" class="btn btn-primary">Paste from Clipboard</button>
          <button onclick="convertToWord()" class="btn btn-success">Convert to Word</button>
          <button onclick="copyForWord()" class="btn btn-info">Copy for Word</button>
          <button onclick="copyForGmail()" class="btn btn-warning">Copy for Gmail</button>
          <button onclick="clearContent()" class="btn btn-secondary">Clear</button>
          <button onclick="showBookmarkletModal()" class="btn btn-primary">Get Bookmarklet</button>
        </div>
      </div>
    </div>
  </div>
  <div id="mbBackdrop" class="backdrop"></div>
  <div id="mb" class="modal">
    <h3>Drag your preferred button into your bookmarks bar</h3>
    <div class="choice"> <a id="dragLast" class="draglet" href="#" draggable="true">R2 Last</a> <a id="dragAll"  class="draglet" href="#" draggable="true">R2 Whole</a> <a id="dragSelection" class="draglet" href="#" draggable="true">R2 Select</a> </div>
    <div class="actions"> <button onclick="closeModal()" class="btn" style="background:#0f1a2e">Close</button> </div>
  </div>
  <div id="toast" class="toast"></div>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>Converting to Word document...</div>
  </div>

  <script>
    // Add event listener for manual paste (Ctrl+V)
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('md');
      
      textarea.addEventListener('paste', function(e) {
        // Delay to let the paste happen first
        setTimeout(() => {
          const currentValue = textarea.value;
          if (currentValue && currentValue.includes('<')) {
            showToast('Processing HTML...');
            const processedHTML = cleanAndValidateHTML(currentValue);
            textarea.value = processedHTML;
            showToast('✅ HTML processed and ready for conversion!');
          }
        }, 100);
      });
    });

        function showToast(message) {
      const el = document.getElementById('toast');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    }

    function clearContent() {
      document.getElementById('md').value = '';
      showToast('Cleared!');
    }



    function pasteFromClipboard() {
      navigator.clipboard.readText().then(text => {
        if (text) {
          showToast('Processing HTML...');
          // Process the HTML before setting it in the textarea
          const processedHTML = cleanAndValidateHTML(text);
          document.getElementById('md').value = processedHTML;
          showToast('✅ HTML processed and ready for conversion!');
        } else {
          showToast('Clipboard empty!');
        }
      }).catch(() => showToast('Paste failed. Use Ctrl+V.'));
    }

    function showLoading(show) {
      const loading = document.getElementById('loading');
      const convertBtn = document.querySelector('button[onclick="convertToWord()"]');
      
      if (show) {
        loading.style.display = 'block';
        convertBtn.disabled = true;
        convertBtn.textContent = 'Converting...';
      } else {
        loading.style.display = 'none';
        convertBtn.disabled = false;
        convertBtn.textContent = 'Convert to Word';
      }
    }

    function cleanAndValidateHTML(htmlContent) {
      // Create a temporary div to parse and clean the HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlContent;
      
      // Remove any script tags for security
      const scripts = tempDiv.querySelectorAll('script');
      scripts.forEach(script => script.remove());
      
      // Remove any style tags that might interfere
      const styles = tempDiv.querySelectorAll('style');
      styles.forEach(style => style.remove());
      
      // CUSTOM RULES - Add your own formatting logic here
      
      // 1. Fix code blocks that might not be properly formatted
      const codeBlocks = tempDiv.querySelectorAll('pre code, pre');
      codeBlocks.forEach(code => {
        if (!code.classList.contains('code-block-processed')) {
          code.classList.add('code-block-processed');
          // Ensure code blocks have proper styling
          code.style.fontFamily = 'Courier New, monospace';
          code.style.backgroundColor = '#f0f0f0';
          code.style.padding = '10px';
          code.style.border = '1px solid #ddd';
          code.style.borderRadius = '4px';
          code.style.whiteSpace = 'pre-wrap';
        }
      });
      
      // 2. Fix inline code that might not be styled
      const inlineCode = tempDiv.querySelectorAll('code:not(pre code)');
      inlineCode.forEach(code => {
        if (!code.classList.contains('inline-code-processed')) {
          code.classList.add('inline-code-processed');
          code.style.fontFamily = 'Courier New, monospace';
          code.style.backgroundColor = '#f0f0f0';
          code.style.padding = '2px 4px';
          code.style.borderRadius = '3px';
        }
      });
      
      // 3. Fix lists that might not be properly structured
      const lists = tempDiv.querySelectorAll('ul, ol');
      lists.forEach(list => {
        if (!list.classList.contains('list-processed')) {
          list.classList.add('list-processed');
          // Ensure proper list styling
          list.style.marginLeft = '20px';
          list.style.marginBottom = '10px';
        }
      });
      
      // 4. Fix tables that might need better formatting
      const tables = tempDiv.querySelectorAll('table');
      tables.forEach(table => {
        if (!table.classList.contains('table-processed')) {
          table.classList.add('table-processed');
          table.style.borderCollapse = 'collapse';
          table.style.width = '100%';
          table.style.marginBottom = '15px';
          
          // Style table cells
          const cells = table.querySelectorAll('td, th');
          cells.forEach(cell => {
            cell.style.border = '1px solid #ccc';
            cell.style.padding = '8px';
            cell.style.textAlign = 'left';
          });
          
          // Style table headers
          const headers = table.querySelectorAll('th');
          headers.forEach(header => {
            header.style.backgroundColor = '#f2f2f2';
            header.style.fontWeight = 'bold';
          });
        }
      });
      
      // 5. Fix blockquotes
      const blockquotes = tempDiv.querySelectorAll('blockquote');
      blockquotes.forEach(quote => {
        if (!quote.classList.contains('quote-processed')) {
          quote.classList.add('quote-processed');
          quote.style.borderLeft = '4px solid #ccc';
          quote.style.paddingLeft = '15px';
          quote.style.marginLeft = '10px';
          quote.style.color = '#555';
          quote.style.fontStyle = 'italic';
        }
      });
      
      // 6. Fix horizontal rules
      const hrs = tempDiv.querySelectorAll('hr');
      hrs.forEach(hr => {
        if (!hr.classList.contains('hr-processed')) {
          hr.classList.add('hr-processed');
          hr.style.border = 'none';
          hr.style.borderTop = '1px solid #ccc';
          hr.style.margin = '20px 0';
        }
      });
      
      // 7. Fix links and remove href attributes (table of contents links don't work in Word)
      const links = tempDiv.querySelectorAll('a');
      links.forEach(link => {
        if (!link.classList.contains('link-processed')) {
          link.classList.add('link-processed');
          link.style.color = '#0066cc';
          link.style.textDecoration = 'underline';
          link.style.textDecorationColor = '#0066cc';
          link.style.textDecorationThickness = '1px';
          link.style.fontWeight = 'normal';
          // Remove href to prevent broken links in Word
          link.removeAttribute('href');
          link.removeAttribute('target');
          // Add link indicator
          if (link.textContent.trim()) {
            link.innerHTML = `${link.innerHTML} [link]`;
          }
        }
      });
      
      // 8. Replace horizontal rules with double line breaks (spacing)
      const horizontalRules = tempDiv.querySelectorAll('hr');
      horizontalRules.forEach(hr => {
        if (!hr.classList.contains('hr-replaced')) {
          hr.classList.add('hr-replaced');
          // Replace hr with two paragraph breaks for spacing
          const spacingDiv = document.createElement('div');
          spacingDiv.innerHTML = '<p>&nbsp;</p><p>&nbsp;</p>';
          hr.parentNode.replaceChild(spacingDiv, hr);
        }
      });
      
      // 9. Fix underlining - convert to <u> tags with proper styling
      const underlinedElements = tempDiv.querySelectorAll('u, [style*="text-decoration: underline"]');
      underlinedElements.forEach(element => {
        if (!element.classList.contains('underline-processed')) {
          element.classList.add('underline-processed');
          // Create a new <u> element
          const uElement = document.createElement('u');
          uElement.innerHTML = element.innerHTML;
          uElement.style.color = element.style.color || '#000000';
          uElement.style.fontWeight = element.style.fontWeight || 'normal';
          element.parentNode.replaceChild(uElement, element);
        }
      });
      
      // 10. Fix strikethrough - convert to <s> tags with proper styling
      const strikethroughElements = tempDiv.querySelectorAll('del, s, strike, [style*="text-decoration: line-through"]');
      strikethroughElements.forEach(element => {
        if (!element.classList.contains('strikethrough-processed')) {
          element.classList.add('strikethrough-processed');
          // Create a new <s> element
          const sElement = document.createElement('s');
          sElement.innerHTML = element.innerHTML;
          sElement.style.color = element.style.color || '#000000';
          sElement.style.fontWeight = element.style.fontWeight || 'normal';
          element.parentNode.replaceChild(sElement, element);
        }
      });
      
      // 11. Add vertical spacing around tables
      const tablesForSpacing = tempDiv.querySelectorAll('table');
      tablesForSpacing.forEach(table => {
        if (!table.classList.contains('table-spacing-processed')) {
          table.classList.add('table-spacing-processed');
          
          // Add spacing before table
          const spacingBefore = document.createElement('p');
          spacingBefore.innerHTML = '&nbsp;';
          spacingBefore.style.marginBottom = '10px';
          table.parentNode.insertBefore(spacingBefore, table);
          
          // Add spacing after table
          const spacingAfter = document.createElement('p');
          spacingAfter.innerHTML = '&nbsp;';
          spacingAfter.style.marginTop = '10px';
          table.parentNode.insertBefore(spacingAfter, table.nextSibling);
        }
      });
      
      // 12. Handle images (convert to text placeholders)
      const images = tempDiv.querySelectorAll('img');
      images.forEach(img => {
        if (!img.classList.contains('image-processed')) {
          img.classList.add('image-processed');
          const placeholder = document.createElement('p');
          const altText = img.alt || 'No description';
          const srcText = img.src ? ` (${img.src})` : '';
          placeholder.innerHTML = `[Image: ${altText}${srcText}]`;
          placeholder.style.color = '#666';
          placeholder.style.fontStyle = 'italic';
          placeholder.style.backgroundColor = '#f9f9f9';
          placeholder.style.padding = '10px';
          placeholder.style.border = '1px dashed #ccc';
          placeholder.style.borderRadius = '4px';
          placeholder.style.margin = '10px 0';
          img.parentNode.replaceChild(placeholder, img);
        }
      });
      
      // 13. Handle collapsible sections (completely remove collapsible functionality)
      const collapsibleSections = tempDiv.querySelectorAll('details, [class*="collapse"], [class*="accordion"]');
      collapsibleSections.forEach(section => {
        if (!section.classList.contains('collapsible-processed')) {
          section.classList.add('collapsible-processed');
          
          // Create a new div to hold all content
          const contentDiv = document.createElement('div');
          contentDiv.style.marginBottom = '15px';
          
          // If it's a details element, extract summary and content
          if (section.tagName.toLowerCase() === 'details') {
            const summary = section.querySelector('summary');
            if (summary) {
              // Add summary as a header
              const header = document.createElement('h4');
              header.innerHTML = summary.innerHTML;
              header.style.color = '#333';
              header.style.fontSize = '16px';
              header.style.marginBottom = '10px';
              header.style.fontWeight = 'bold';
              header.style.borderBottom = '1px solid #ccc';
              header.style.paddingBottom = '5px';
              contentDiv.appendChild(header);
            }
            
            // Add all other content (everything except summary)
            Array.from(section.children).forEach(child => {
              if (child.tagName.toLowerCase() !== 'summary') {
                const clonedChild = child.cloneNode(true);
                // Ensure proper spacing for list items
                if (clonedChild.tagName.toLowerCase() === 'ul' || clonedChild.tagName.toLowerCase() === 'ol') {
                  clonedChild.style.marginLeft = '20px';
                  clonedChild.style.marginBottom = '10px';
                }
                contentDiv.appendChild(clonedChild);
              }
            });
          } else {
            // For other collapsible elements, just extract all content
            Array.from(section.children).forEach(child => {
              const clonedChild = child.cloneNode(true);
              contentDiv.appendChild(clonedChild);
            });
          }
          
          // Replace the collapsible section with the content
          section.parentNode.replaceChild(contentDiv, section);
        }
      });
      
      // 14. Handle math elements (convert to plain text)
      const mathElements = tempDiv.querySelectorAll('math, [class*="math"], [class*="katex"]');
      mathElements.forEach(math => {
        if (!math.classList.contains('math-processed')) {
          math.classList.add('math-processed');
          const mathText = document.createElement('p');
          mathText.innerHTML = `[Math: ${math.textContent || math.innerText}]`;
          mathText.style.fontFamily = 'Courier New, monospace';
          mathText.style.backgroundColor = '#f0f0f0';
          mathText.style.padding = '5px';
          mathText.style.borderRadius = '3px';
          math.parentNode.replaceChild(mathText, math);
        }
      });
      
      // Ensure proper HTML structure
      let cleanedHTML = tempDiv.innerHTML;
      
      // If it's just text, wrap it in paragraphs
      if (!cleanedHTML.includes('<')) {
        cleanedHTML = `<p>${cleanedHTML}</p>`;
      }
      
      // Create complete HTML document as required by html-docx-js
      cleanedHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <style>
            body { font-family: Calibri, sans-serif; font-size: 11pt; line-height: 1.4; margin: 20px; }
            h1 { font-size: 24pt; font-weight: bold; margin-top: 24px; margin-bottom: 12px; color: #000; }
            h2 { font-size: 18pt; font-weight: bold; margin-top: 18px; margin-bottom: 9px; color: #000; }
            h3 { font-size: 14pt; font-weight: bold; margin-top: 14px; margin-bottom: 7px; color: #000; }
            h4 { font-size: 12pt; font-weight: bold; margin-top: 12px; margin-bottom: 6px; color: #000; }
            p { margin: 0 0 10px 0; color: #000; }
            pre { background-color: #f0f0f0; padding: 10px; font-family: 'Courier New', monospace; border: 1px solid #ddd; white-space: pre-wrap; margin: 10px 0; color: #000; }
            blockquote { border-left: 2px solid #ccc; padding-left: 10px; margin-left: 5px; color: #555; font-style: italic; }
            ul, ol { margin-top: 0; margin-bottom: 10px; padding-left: 40px; color: #000; }
            li { margin-bottom: 5px; color: #000; }
            table { border-collapse: collapse; margin-bottom: 15px; width: 100%; }
            td, th { border: 1px solid #ccc; padding: 8px; color: #000; }
            th { font-weight: bold; background-color: #f2f2f2; }
            code { font-family: 'Courier New', monospace; background-color: #f0f0f0; padding: 2px 4px; color: #000; }
            u { text-decoration: underline; color: #000; }
            s { text-decoration: line-through; color: #000; }
            a { color: #0066cc; text-decoration: underline; }
            hr { border: none; border-top: 1px solid #ccc; margin: 20px 0; }
          </style>
        </head>
        <body>
          ${cleanedHTML}
        </body>
        </html>
      `;
      
      return cleanedHTML;
    }

    function copyAsRichText() {
      const htmlContent = document.getElementById('md').value;
      if (!htmlContent.trim()) {
        showToast('Nothing to copy!');
        return;
      }

      try {
        // Clean and validate the HTML (same processing as Word conversion)
        const cleanedHTML = cleanAndValidateHTML(htmlContent);
        
        // Create a temporary div to hold the processed HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cleanedHTML;
        
        // Extract just the body content (remove the HTML document wrapper)
        const bodyContent = tempDiv.querySelector('body');
        const htmlToCopy = bodyContent ? bodyContent.innerHTML : tempDiv.innerHTML;
        
        // Create a blob with the HTML content
        const htmlBlob = new Blob([htmlToCopy], { type: 'text/html' });
        const textBlob = new Blob([tempDiv.textContent || tempDiv.innerText], { type: 'text/plain' });
        
        // Use the Clipboard API to copy both HTML and text formats
        const clipboardItem = new ClipboardItem({
          'text/html': htmlBlob,
          'text/plain': textBlob
        });
        
        navigator.clipboard.write([clipboardItem]).then(() => {
          showToast('✅ Rich text copied! Paste into Word for perfect formatting.');
        }).catch(() => {
          // Fallback: try to copy as plain text
          navigator.clipboard.writeText(tempDiv.textContent || tempDiv.innerText).then(() => {
            showToast('✅ Text copied! (Rich formatting not available)');
          }).catch(() => {
            showToast('❌ Copy failed. Try selecting and copying manually.');
          });
        });
        
      } catch (error) {
        console.error('Error:', error);
        showToast('❌ Copy failed. Please try again.');
      }
    }



    function copyForWord() {
      const htmlContent = document.getElementById('md').value;
      if (!htmlContent.trim()) {
        showToast('Nothing to copy!');
        return;
      }

      // Check if library is loaded
      if (typeof htmlDocx === 'undefined') {
        showToast('❌ Conversion library failed to load. Please refresh the page.');
        return;
      }

      showLoading(true);

      try {
        // Clean and validate the HTML (SAME AS convertToWord)
        const cleanedHTML = cleanAndValidateHTML(htmlContent);
        
        // Convert HTML to DOCX using html-docx-js with proper options (SAME AS convertToWord)
        const options = {
          orientation: 'portrait',
          margins: {
            top: 1440,
            right: 1440,
            bottom: 1440,
            left: 1440
          }
        };

        const fileBuffer = htmlDocx.asBlob(cleanedHTML, options);
        
        // Instead of downloading, copy the processed content to clipboard
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cleanedHTML;
        
        // Extract just the body content (remove the HTML document wrapper)
        const bodyContent = tempDiv.querySelector('body');
        const htmlToCopy = bodyContent ? bodyContent.innerHTML : tempDiv.innerHTML;
        
        // Create a blob with the HTML content for rich text copying
        const htmlBlob = new Blob([htmlToCopy], { type: 'text/html' });
        const textBlob = new Blob([tempDiv.textContent || tempDiv.innerText], { type: 'text/plain' });
        
        // Use the Clipboard API to copy both HTML and text formats
        const clipboardItem = new ClipboardItem({
          'text/html': htmlBlob,
          'text/plain': textBlob
        });
        
        navigator.clipboard.write([clipboardItem]).then(() => {
          showLoading(false);
          showToast('✅ Content copied! Paste into Word for perfect formatting.');
        }).catch(() => {
          // Fallback: try to copy as plain text
          navigator.clipboard.writeText(tempDiv.textContent || tempDiv.innerText).then(() => {
            showLoading(false);
            showToast('✅ Text copied! (Rich formatting not available)');
          }).catch(() => {
            showLoading(false);
            showToast('❌ Copy failed. Try selecting and copying manually.');
          });
        });
        
      } catch (error) {
        console.error('Error:', error);
        showLoading(false);
        showToast('❌ Copy failed. Please try again.');
      }
    }

    function copyForGmail() {
      const htmlContent = document.getElementById('md').value;
      if (!htmlContent.trim()) {
        showToast('Nothing to copy!');
        return;
      }

      try {
        // Apply all our custom rules first
        const processedHTML = cleanAndValidateHTML(htmlContent);
        
        // Create a temporary div to convert for Gmail
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = processedHTML;
        
        // Extract just the body content
        const bodyContent = tempDiv.querySelector('body');
        const contentToProcess = bodyContent ? bodyContent.innerHTML : tempDiv.innerHTML;
        
        // Create a new div for Gmail-specific conversion
        const gmailDiv = document.createElement('div');
        gmailDiv.innerHTML = contentToProcess;
        
        // GMAIL-SPECIFIC CONVERSIONS:
        
        // 1. Convert code blocks to Gmail-friendly format
        const codeBlocks = gmailDiv.querySelectorAll('pre code, pre');
        codeBlocks.forEach(code => {
          const gmailCode = document.createElement('div');
          gmailCode.style.fontFamily = 'monospace';
          gmailCode.style.backgroundColor = '#f5f5f5';
          gmailCode.style.padding = '10px';
          gmailCode.style.border = '1px solid #ddd';
          gmailCode.style.borderRadius = '4px';
          gmailCode.style.margin = '10px 0';
          gmailCode.style.whiteSpace = 'pre-wrap';
          gmailCode.style.fontSize = '12px';
          gmailCode.style.lineHeight = '1.4';
          gmailCode.innerHTML = code.innerHTML;
          code.parentNode.replaceChild(gmailCode, code);
        });
        
        // 2. Convert inline code
        const inlineCode = gmailDiv.querySelectorAll('code:not(pre code)');
        inlineCode.forEach(code => {
          const gmailInlineCode = document.createElement('span');
          gmailInlineCode.style.fontFamily = 'monospace';
          gmailInlineCode.style.backgroundColor = '#f0f0f0';
          gmailInlineCode.style.padding = '2px 4px';
          gmailInlineCode.style.borderRadius = '3px';
          gmailInlineCode.style.fontSize = '12px';
          gmailInlineCode.innerHTML = code.innerHTML;
          code.parentNode.replaceChild(gmailInlineCode, code);
        });
        
        // 3. Convert tables to Gmail-friendly format
        const tables = gmailDiv.querySelectorAll('table');
        tables.forEach(table => {
          table.style.borderCollapse = 'collapse';
          table.style.width = '100%';
          table.style.marginBottom = '15px';
          table.style.fontSize = '14px';
          
          const cells = table.querySelectorAll('td, th');
          cells.forEach(cell => {
            cell.style.border = '1px solid #ddd';
            cell.style.padding = '8px';
            cell.style.textAlign = 'left';
            cell.style.verticalAlign = 'top';
          });
          
          const headers = table.querySelectorAll('th');
          headers.forEach(header => {
            header.style.backgroundColor = '#f8f9fa';
            header.style.fontWeight = 'bold';
          });
        });
        
        // 4. Convert blockquotes
        const blockquotes = gmailDiv.querySelectorAll('blockquote');
        blockquotes.forEach(quote => {
          quote.style.borderLeft = '4px solid #4285f4';
          quote.style.paddingLeft = '15px';
          quote.style.marginLeft = '10px';
          quote.style.color = '#5f6368';
          quote.style.fontStyle = 'italic';
          quote.style.backgroundColor = '#f8f9fa';
          quote.style.padding = '10px 15px';
          quote.style.borderRadius = '4px';
        });
        
        // 5. Convert lists for Gmail
        const lists = gmailDiv.querySelectorAll('ul, ol');
        lists.forEach(list => {
          list.style.marginLeft = '20px';
          list.style.marginBottom = '10px';
          list.style.fontSize = '14px';
          list.style.lineHeight = '1.6';
        });
        
        // 6. Convert headings for Gmail
        const headings = gmailDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
        headings.forEach(heading => {
          heading.style.color = '#202124';
          heading.style.fontWeight = 'bold';
          heading.style.marginTop = '20px';
          heading.style.marginBottom = '10px';
          heading.style.fontSize = heading.tagName === 'H1' ? '24px' : 
                                  heading.tagName === 'H2' ? '20px' : 
                                  heading.tagName === 'H3' ? '18px' : '16px';
        });
        
        // 7. Convert links for Gmail
        const links = gmailDiv.querySelectorAll('a');
        links.forEach(link => {
          link.style.color = '#1a73e8';
          link.style.textDecoration = 'underline';
          link.style.textDecorationColor = '#1a73e8';
        });
        
        // 8. Convert paragraphs for Gmail
        const paragraphs = gmailDiv.querySelectorAll('p');
        paragraphs.forEach(p => {
          p.style.margin = '0 0 10px 0';
          p.style.fontSize = '14px';
          p.style.lineHeight = '1.6';
          p.style.color = '#202124';
        });
        
        // Create the final Gmail-optimized HTML
        const gmailHTML = gmailDiv.innerHTML;
        
        // Create a blob with the Gmail-optimized HTML content
        const htmlBlob = new Blob([gmailHTML], { type: 'text/html' });
        const textBlob = new Blob([gmailDiv.textContent || gmailDiv.innerText], { type: 'text/plain' });
        
        // Use the Clipboard API to copy both HTML and text formats
        const clipboardItem = new ClipboardItem({
          'text/html': htmlBlob,
          'text/plain': textBlob
        });
        
        navigator.clipboard.write([clipboardItem]).then(() => {
          showToast('✅ Gmail-optimized content copied! Paste into Gmail for perfect formatting.');
        }).catch(() => {
          // Fallback: try to copy as plain text
          navigator.clipboard.writeText(gmailDiv.textContent || gmailDiv.innerText).then(() => {
            showToast('✅ Text copied! (Rich formatting not available)');
          }).catch(() => {
            showToast('❌ Copy failed. Try selecting and copying manually.');
          });
        });
        
      } catch (error) {
        console.error('Error:', error);
        showToast('❌ Copy failed. Please try again.');
      }
    }

    function convertToWord() {
      const htmlContent = document.getElementById('md').value;
      if (!htmlContent.trim()) {
        showToast('Nothing to convert!');
        return;
      }

      // Check if library is loaded
      if (typeof htmlDocx === 'undefined') {
        showToast('❌ Conversion library failed to load. Please refresh the page.');
        return;
      }

      showLoading(true);

      try {
        // Clean and validate the HTML
        const cleanedHTML = cleanAndValidateHTML(htmlContent);
        
                // Convert HTML to DOCX using html-docx-js with proper options
        const options = {
          orientation: 'portrait',
          margins: {
            top: 1440,
            right: 1440,
            bottom: 1440,
            left: 1440
          }
        };

        const fileBuffer = htmlDocx.asBlob(cleanedHTML, options);
        const blob = new Blob([fileBuffer], { 
          type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
        });
          
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'R2_GPT_Export.docx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showLoading(false);
        showToast('✅ Word document downloaded!');
        
      } catch (error) {
        console.error('Error:', error);
        showLoading(false);
        showToast('❌ Conversion failed. Please try again.');
      }
    }

    function showBookmarkletModal() {
      const last = `javascript:(function(){try{const e=document.querySelectorAll('div[data-message-author-role="assistant"]');if(!e.length)return alert("No responses found.");const t=e[e.length-1].querySelector(".markdown,.prose");t?navigator.clipboard.writeText(t.outerHTML).then(()=>alert("Last response HTML copied!")).catch(e=>alert("Failed to copy")):alert("Could not find content.")}catch(e){alert("Error: "+e.message)}})();`;
      const all = `javascript:(function(){try{const e=document.querySelectorAll('div[data-message-author-role="assistant"]');if(!e.length)return alert("No responses found.");let t="";e.forEach((n,o)=>{const r=n.querySelector(".markdown,.prose");r&&(t+=r.outerHTML,o<e.length-1&&(t+="<hr>"))}),t?navigator.clipboard.writeText(t).then(()=>alert("All responses HTML copied!")).catch(e=>alert("No content found."))}catch(e){alert("Error: "+e.message)}})();`;
      const selection = `javascript:(function(){try{const selection=window.getSelection();if(!selection.rangeCount)return alert("Please select some text first!");const range=selection.getRangeAt(0);const container=range.commonAncestorContainer;let element=container.nodeType===1?container:container.parentElement;while(element&&!element.classList.contains('markdown')&&!element.classList.contains('prose')){element=element.parentElement}if(!element)return alert("Could not find formatted content for selection.");const tempDiv=document.createElement('div');tempDiv.appendChild(range.cloneContents());const selectedHTML=tempDiv.innerHTML;if(!selectedHTML.trim())return alert("No content selected!");navigator.clipboard.writeText(selectedHTML).then(()=>alert("Selected content HTML copied!")).catch(e=>alert("Failed to copy"))}catch(e){alert("Error: "+e.message)}})();`;
      document.getElementById('dragLast').href = last;
      document.getElementById('dragAll').href = all;
      document.getElementById('dragSelection').href = selection;
      document.getElementById('mb').style.display = 'block';
      document.getElementById('mbBackdrop').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('mb').style.display = 'none';
      document.getElementById('mbBackdrop').style.display = 'none';
    }
  </script>
</body>
</html>
