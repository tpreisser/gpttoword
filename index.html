<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700&display=swap" rel="stylesheet">
    <title>R² Solutions · GPT → DOCX Converter</title>
    <style>
      :root{
        --font:'Plus Jakarta Sans',sans-serif;
        --navy:#0a041a; --blue:#3c67e3; --violet:#8b5cf6;
        --light:#e2e8f0; --panel:rgba(20,15,40,.6); --panel-bd:rgba(139,92,246,.35);
        --field-bd:rgba(139,92,246,.35); --bd:#1f2937; --backdrop:rgba(4,7,20,.72);
      }
      html,body{margin:0;padding:0;height:100%;font-family:var(--font);background:var(--navy);color:var(--light);}
      body{display:flex;justify-content:center;text-align:center}
      body::before{content:'';position:fixed;left:0;top:0;width:520px;height:520px;background:radial-gradient(circle,var(--blue),var(--violet));filter:blur(180px);opacity:.35;pointer-events:none;animation:pan 22s ease-in-out infinite alternate;z-index:0}
      @keyframes pan{from{transform:translate(-40%,-40%) scale(1)}to{transform:translate(40%,40%) scale(1.5)}}
      .main{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:1rem;padding:2rem 2rem 4rem;width:100%}
      .logo{width:min(900px,92vw);height:auto;display:block;margin:0 auto;transform:translateX(60px)}
      .sub{font-size:1.06rem;font-weight:400;max-width:900px;line-height:1.5;margin-top:.25rem;background:linear-gradient(90deg,#a7b7e8,#c6b2f8);-webkit-background-clip:text;background-clip:text;color:transparent}
      .box{margin-top:1.2rem;width:clamp(360px,92vw,1100px);background:var(--panel);border:1px solid var(--panel-bd);border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,.45);overflow:visible;display:flex;flex-direction:column;backdrop-filter:blur(10px)}
      .hdr{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1.2rem;background:linear-gradient(90deg,var(--blue),var(--violet))}
      .hdr .l{display:flex;align-items:baseline;gap:10px}
      .hdr .title{font-weight:700;color:#fff;font-size:1.15rem}
      .hdr .v{font-weight:500;color:rgba(255,255,255,.8);font-size:.86rem}
      #status-indicator { font-size: 1.5rem; line-height: 1; vertical-align: middle; color: #e11d48; /* Red by default */ }
      .dots{display:flex;gap:7px}.dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,.35)}
      .body{padding:18px;display:flex;flex-direction:column;gap:14px;text-align:left}
      .md{width:100%;min-height:320px;resize:vertical;background:#0a0f1e;border:1px solid var(--field-bd);color:#e2e8f0;border-radius:12px;padding:16px;box-sizing:border-box;font-size:1.05rem;line-height:1.6;outline:none}
      .controls{display:flex;gap:.8rem;flex-wrap:wrap;align-items:center;margin-top:10px}
      .filename{background:#0a0f1e;border:1px solid var(--field-bd);color:#e2e8f0;border-radius:12px;padding:.75rem 1rem;min-width:260px;flex:1}
      .btn{appearance:none;border:1px solid var(--bd);background:#10192e;color:#e6faff;border-radius:12px;padding:.75rem 1rem;font-weight:800;cursor:pointer;transition:.18s}
      .btn:hover{transform:translateY(-1px);border-color:#8b5cf6}
      .btn.good{border-color:#15b57b}
      .backdrop{position:fixed;inset:0;background:var(--backdrop);display:none;z-index:50}
      .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(560px,92vw);background:#0b1022;border:1px solid var(--panel-bd);border-radius:16px;padding:18px;box-shadow:0 20px 50px rgba(0,0,0,.6);display:none;z-index:51;text-align:left}
      .modal h3{margin:0 0 8px}
      .choice{display:flex;flex-direction:column;row-gap:14px;margin:12px 0}
      .draglet{display:block;text-align:center;width:100%;box-sizing:border-box;padding:14px 16px;border-radius:999px;border:1px solid var(--field-bd);background:linear-gradient(90deg,rgba(60,103,227,.25),rgba(139,92,246,.25));color:#eef;font-weight:900;text-decoration:none;user-select:none;cursor:grab}
      .draglet:active{cursor:grabbing}
      .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
      .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#0a1a2e;border:1px solid #1e293b;padding:10px 14px;border-radius:10px;color:#e2f3ff;display:none;z-index:60;transition:opacity .3s}
    </style>
</head>
<body>
  <div class="main">
    <img class="logo" src="https://drive.google.com/thumbnail?id=1E2DohDh27ZnzCyYT9hSL1aanKdLQbDla&sz=s4000" alt="R² Solutions"/>
    <p class="sub">Powered by AI · Built by R² Solutions</p>
    <div class="box">
      <div class="hdr">
        <div class="l">
            <span class="title">R² Solutions · GPT → DOCX Converter</span>
            <span class="v">v4.0</span>
            <span id="status-indicator" title="Library Status">●</span>
        </div>
        <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      </div>
      <div class="body">
        <textarea id="md" class="md" placeholder="1. Click the bookmarklet in ChatGPT.&#10;2. Click 'Paste from Clipboard' here.&#10;3. Click 'Download .docx'."></textarea>
        <div class="controls">
          <input id="filename" class="filename" type="text" value="R2 GPT Export.docx"/>
          <button onclick="APP.pasteFromClipboard()" class="btn">Paste from Clipboard</button>
          <button onclick="APP.downloadDocx()" class="btn good" title="Build a native .docx">Download .docx</button>
          <button onclick="APP.clearContent()" class="btn" style="background:#0f1a2e">Clear</button>
          <button onclick="APP.showBookmarkletModal()" class="btn" title="Install the one-click ChatGPT copier">Get Bookmarklet</button>
        </div>
      </div>
    </div>
  </div>

  <div id="mbBackdrop" class="backdrop"></div>
  <div id="mb" class="modal">
    <h3>Drag your preferred button into your bookmarks bar</h3>
    <div class="choice">
      <a id="dragLast" class="draglet" href="#" draggable="true">R2 GPT Convert — Last</a>
      <a id="dragAll"  class="draglet" href="#" draggable="true">R2 GPT Convert — Whole</a>
    </div>
    <div class="actions">
      <button onclick="APP.closeModal()" class="btn" style="background:#0f1a2e">Close</button>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <script>
    // Create a global application object to hold everything
    window.APP = {};

    // --- EMBEDDED CONVERTER LIBRARY ---
    // This immediately-invoked function expression (IIFE) loads the library
    // and attaches it to our global APP object.
    (function() {
      try {
        const libraryCode = function(e){"use strict";var t={341:function(e,t,n){var r=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0}),t.Document=void 0;var o=n(962),i=n(228),a=n(829),s=function(e){function t(t){var n=e.call(this)||this;return n.margins=null==t?void 0:t.margins,n.numbering=null!=t&&t.numbering?new i.Numbering(null==t?void 0:t.numbering):void 0,n.section=new a.Section(t||{}),n.reset(),n}return r(t,e),t.prototype.reset=function(){this.parts=[],this.part=this.createPart(),this.parts.push(this.part)},t.prototype.createPart=function(){return new o.Part},t.prototype.addParagraph=function(e){return this.part.addParagraph(e),this},t.prototype.addTable=function(e){return this.part.addTable(e),this},t.prototype.toString=function(){var e=this,t='<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:w10="urn:schemas-microsoft-com:office:word" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:wps="http://schemas.microsoft.com/office/word/2010/wordprocessingShape" xmlns:wpg="http://schemas.microsoft.com/office/word/2010/wordprocessingGroup" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing" xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" mc:Ignorable="w14 wp14">',n=this.parts.map((function(e){return e.toString()})).join(""),r=this.section.toString(e.margins);return t+("<w:body>"+n+r+"</w:body></w:document>")},t}(o.Part);t.Document=s},829:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Section=void 0;var n=function(){function e(e){this.config=e}return e.prototype.toString=function(e){var t="";return this.config.header&&(t+=this.config.header.toString(this.config.header.type)),this.config.footer&&(t+=this.config.footer.toString(this.config.footer.type)),t+=this.config.break?"<w:p><w:r><w:br w:type='page' /></w:r></w:p>":"",t+='<w:sectPr><w:headerReference w:type="default" r:id="'.concat(this.config.header.id,'"/><w:footerReference w:type="default" r:id="').concat(this.config.footer.id,'"/><w:pgSz w:w="12240" w:h="15840"/><w:pgMar w:top="').concat((e=e||{}).top||1440,'" w:right="').concat(e.right||1440,'" w:bottom="').concat(e.bottom||1440,'" w:left="').concat(e.left||1440,'" w:header="').concat(e.header||720,'" w:footer="').concat(e.footer||720,'" w:gutter="').concat(e.gutter||0,'"/> <w:cols w:space="720"/><w:docGrid w:linePitch="360"/></w:sectPr>'},e}();t.Section=n},962:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.Part=void 0;var r=n(308),o=n(60),i=function(){function e(){this.children=[]}return e.prototype.addParagraph=function(e){return this.children.push(new r.Paragraph(e)),this},e.prototype.addTable=function(e){return this.children.push(new o.Table(e)),this},e.prototype.toString=function(){return this.children.map((function(e){return e.toString()})).join("")},e}();t.Part=i},308:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.Paragraph=void 0;var r=n(651),o=function(){function e(e){this.children=[],this.text=e||"",this.properties=new r.ParagraphProperties(null==e?void 0:e.properties),this.children=this.text?this.text.split("\n").map((function(e){var t=document.createElement("span");return t.innerHTML=e,t.innerText})):[""]}return e.prototype.addRun=function(e){return this.children.push(e),this},e.prototype.toString=function(){var e=this.properties.toString(),t=this.children.map((function(e){return"<w:r>".concat(e,"</w:r>")})).join("");return"<w:p>".concat(e).concat(t,"</w:p>")},e}();t.Paragraph=o},651:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ParagraphProperties=void 0;var n=function(){function e(e){this.numbering=null==e?void 0:e.numbering}return e.prototype.toString=function(){if(!this.numbering)return"<w:pPr></w:pPr>";var e="";return e+="<w:pPr><w:numPr><w:ilvl w:val='".concat(this.numbering.level,"' /><w:numId w:val='").concat(this.numbering.id,"' /></w:numPr></w:pPr>"},e}();t.ParagraphProperties=n},60:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.Table=void 0;var r=n(308),o=function(){function e(e){this.rows=e.rows.map((function(e){return new i(e)}))}return e.prototype.toString=function(){return'<w:tbl><w:tblPr><w:tblStyle w:val="TableGrid"/><w:tblW w:w="0" w:type="auto"/><w:tblLook w:val="04A0" w:firstRow="1" w:lastRow="0" w:firstColumn="1" w:lastColumn="0" w:noHBand="0" w:noVBand="1"/></w:tblPr><w:tblGrid><w:gridCol w:w="8724"/></w:tblGrid>'.concat(this.rows.map((function(e){return e.toString()})).join(""),"</w:tbl>")},e}();t.Table=o;var i=function(){function e(e){this.cells=e.cells.map((function(e){return new a(e)}))}return e.prototype.toString=function(){return"<w:tr>".concat(this.cells.map((function(e){return e.toString()})).join(""),"</w:tr>")},e}(),a=function(){function e(e){this.children=e.children.map((function(e){return new r.Paragraph(e.text)}))}return e.prototype.toString=function(){return"<w:tc><w:tcPr><w:tcW w:w='".concat(8724,"' w:type='dxa'/></w:tcPr>").concat(this.children.map((function(e){return e.toString()})).join(""),"</w:tc>")},e}()},228:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Numbering=void 0;var n=function(){function e(e){this.config=e.config.map((function(e){return{level:e.level,format:e.format,text:e.text,pStyle:e.pStyle}}))}return e.prototype.toString=function(){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:numbering xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:w15="http://schemas.microsoft.com/office/word/2012/wordml" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" mc:Ignorable="w15"><w:abstractNum w:abstractNumId="0"><w:nsid w:val="292BC9A9"/><w:multiLevelType w:val="multilevel"/><w:tmpl w:val="0409001D"/>'.concat(this.config.map((function(e,t){return'<w:lvl w:ilvl="'.concat(e.level,'"><w:start w:val="1"/><w:numFmt w:val="').concat(e.format,'"/><w:lvlText w:val="').concat(e.text,'"/><w:lvlJc w:val="left"/><w:pPr><w:ind w:left="').concat(720*(t+1),'" w:hanging="360"/></w:pPr></w:lvl>')})).join(""),'</w:abstractNum><w:num w:numId="1" w:restart="1"><w:abstractNumId w:val="0"/></w:num></w:numbering>')},e}();t.Numbering=n},102:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function s(e){e.done?o(e.value):new n((function(t){t(e.value)})).then(a,i)}s((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.asBlob=void 0;var o=n(341),i=n(545);t.asBlob=function(e,t){return r(this,void 0,void 0,(function*(){return new Promise((function(n,r){try{var a=new o.Document(t);new i.default(a).process(e),n(a)}catch(e){r(e)}})).then((function(e){return(new(n(891)).Packer).toBlob(e)}))}))}},545:function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.doc=e}return e.prototype.process=function(e){var t=this,n=(new DOMParser).parseFromString(e,"text/html");return n.body.childNodes.forEach((function(e){var n=t.processNode(e);Array.isArray(n)?n.forEach((function(e){return t.doc.addParagraph(e)})):n&&t.doc.addParagraph(n)})),this.doc},e.prototype.processNode=function(e,t){var n="";switch(void 0===t&&(t={}),e.nodeName.toLowerCase()){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":n=e.outerHTML;break;case"p":n=e.outerHTML;break;case"div":n=e.innerHTML;break;case"ul":case"ol":return this.processList(e,t);case"table":return this.processTable(e);case"br":n="<br/>";break;case"#text":n=e.textContent;break;default:n=e.outerHTML}return n},e.prototype.processList=function(e,t){var n=this;void 0===t&&(t={});var r=[],o="ul"===e.nodeName.toLowerCase()?0:1,i=0;return e.childNodes.forEach((function(e){if("li"===e.nodeName.toLowerCase()){var a=n.processNode(e,Object.assign(Object.assign({},t),{numbering:{id:o,level:i}}));r.push(a)}})),r},e.prototype.processTable=function(e){var t=this,n={rows:[]};return e.querySelectorAll("tr").forEach((function(e){var r={cells:[]};e.querySelectorAll("td").forEach((function(e){var n={children:[]},o=e.innerHTML;n.children.push({text:o}),r.cells.push(n)})),n.rows.push(r)})),this.doc.addTable(n),null},e}();t.default=n},891:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.Packer=void 0;var r=n(341),o=function(){function e(){}return e.prototype.toBlob=function(e){var t=n(452),o=new t;o.file("[Content_Types].xml",this.contentTypes(e)),o.file("_rels/.rels",this.relationships(e));var i=o.folder("word");return i.file("document.xml",this.document(e)),i.file("_rels/document.xml.rels",this.documentRelationships(e)),e.numbering&&i.file("numbering.xml",this.numbering(e)),e.section.config.header&&i.file("header1.xml",this.header(e.section.config.header)),e.section.config.footer&&i.file("footer1.xml",this.footer(e.section.config.footer)),o.generateAsync({type:"blob",mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"})},e.prototype.header=function(e){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:hdr xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">'.concat(e.toString(),"</w:hdr>")},e.prototype.footer=function(e){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:ftr xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">'.concat(e.toString(),"</w:ftr>")},e.prototype.contentTypes=function(e){var t=['<?xml version="1.0" encoding="UTF-8" standalone="yes"?>','<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">','<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>','<Default Extension="xml" ContentType="application/xml"/>','<Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>'];return e.numbering&&t.push('<Override PartName="/word/numbering.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.numbering+xml"/>'),e.section.config.header&&t.push('<Override PartName="/word/header1.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.header+xml" />'),e.section.config.footer&&t.push('<Override PartName="/word/footer1.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.footer+xml" />'),t.push("</Types>"),t.join("")},e.prototype.relationships=function(e){var t,n,o='<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">';return o+='<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>',e.section.config.header&&(null===(t=e.section.config.header)||void 0===t?void 0:t.id)&&(o+='<Relationship Id="'.concat(e.section.config.header.id,'" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/header" Target="header1.xml"/>')),e.section.config.footer&&(null===(n=e.section.config.footer)||void 0===n?void 0:n.id)&&(o+='<Relationship Id="'.concat(e.section.config.footer.id,'" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/footer" Target="footer1.xml"/>')),o+="</Relationships>"},e.prototype.document=function(e){return e instanceof r.Document?e.toString():new r.Document(e).toString()},e.prototype.documentRelationships=function(e){var t='<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">';return e.section.config.header&&(t+='<Relationship Id="'.concat(e.section.config.header.id,'" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/header" Target="header1.xml" />')),e.section.config.footer&&(t+='<Relationship Id="'.concat(e.section.config.footer.id,'" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/footer" Target="footer1.xml"/>')),t+="</Relationships>"},e.prototype.numbering=function(e){return e.numbering.toString()},e}();t.Packer=o}},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var i=n[e]={exports:{}};return t[e].call(i.exports,i,i.exports,r),i.exports}return r.d=function(e,t){for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r(452=function(){try{return require("jszip")}catch(e){}}()),r(102)};
        window.APP.converter = libraryCode({});
      } catch (err) {
        console.error("Failed to initialize the converter library:", err);
        window.APP.converter = null;
      }
    })();

    // --- APPLICATION LOGIC ---
    // All functions are now part of the global APP object.
    
    APP.showToast = function(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';
      toast.style.opacity = 1;
      setTimeout(() => {
        toast.style.opacity = 0;
        setTimeout(() => { toast.style.display = 'none'; }, 300);
      }, 3000);
    };

    APP.clearContent = function() {
      document.getElementById('md').value = '';
      APP.showToast('Cleared!');
    };
    
    APP.pasteFromClipboard = function() {
      navigator.clipboard.readText().then(text => {
        if (text && text.trim()) {
          document.getElementById('md').value = text;
          APP.showToast('Pasted HTML from clipboard!');
        } else {
          APP.showToast('Clipboard is empty!');
        }
      }).catch(err => {
        console.error('Clipboard access failed:', err);
        APP.showToast('Clipboard access failed. Use Ctrl+V to paste manually.');
      });
    };
    
    APP.downloadDocx = async function() {
      if (!APP.converter || typeof APP.converter.asBlob !== 'function') {
        APP.showToast('FATAL ERROR: Converter is not loaded. Check status indicator.');
        return;
      }

      const htmlContent = document.getElementById('md').value;
      if (!htmlContent.trim()) {
        APP.showToast('Nothing to download!');
        return;
      }
      
      const styledHtml = `
        <!DOCTYPE html><html><head><meta charset="UTF-8"><style>
        body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; line-height: 1.5; }
        pre { background-color: #f0f0f0; padding: 1em; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; border: 1px solid #ccc; border-radius: 4px; }
        code { font-family: 'Courier New', Courier, monospace; }
        blockquote { border-left: 3px solid #ccc; margin-left: 1.5em; padding-left: 1em; color: #555; }
        table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        ul, ol { padding-left: 2em; }
        </style></head><body>${htmlContent}</body></html>
      `;

      try {
        const fileBlob = await APP.converter.asBlob(styledHtml);
        const filenameInput = document.getElementById('filename').value || 'R2 GPT Export';
        const base = filenameInput.replace(/\.(docx|rtf|txt)$/i, '');
        
        const a = document.createElement('a');
        a.href = URL.createObjectURL(fileBlob);
        a.download = `${base}.docx`;
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => { URL.revokeObjectURL(a.href); document.body.removeChild(a); }, 100);
        APP.showToast('✅ DOCX document downloaded!');

      } catch (error) {
        console.error('Error generating DOCX:', error);
        APP.showToast('An error occurred during DOCX generation.');
      }
    };
    
    APP.showBookmarkletModal = function() {
      const bookmarkletLast = `javascript:(function(){try{const e=document.querySelectorAll('div[data-message-author-role="assistant"]');if(!e.length)return void alert("No ChatGPT responses found.");const t=e[e.length-1].querySelector(".markdown, .prose");t?navigator.clipboard.writeText(t.innerHTML).then(()=>alert("Last ChatGPT response (HTML) copied!")).catch(e=>alert("Failed to copy: "+e)):alert("Could not find response content.")}catch(e){alert("An error occurred: "+e.message)}})();`;
      const bookmarkletAll = `javascript:(function(){try{const e=document.querySelectorAll('div[data-message-author-role="assistant"]');if(!e.length)return void alert("No ChatGPT responses found.");let t="";e.forEach((n,o)=>{const r=n.querySelector(".markdown, .prose");r&&(t+=r.innerHTML,o<e.length-1&&(t+="<hr>"))}),t?navigator.clipboard.writeText(t).then(()=>alert("All ChatGPT responses (HTML) copied!")).catch(e=>alert("Failed to copy: "+e)):alert("Could not find any content to copy.")}catch(e){alert("An error occurred: "+e.message)}})();`;
      
      document.getElementById('dragLast').href = bookmarkletLast;
      document.getElementById('dragAll').href = bookmarkletAll;
      document.getElementById('mb').style.display = 'block';
      document.getElementById('mbBackdrop').style.display = 'block';
    };
    
    APP.closeModal = function() {
      document.getElementById('mb').style.display = 'none';
      document.getElementById('mbBackdrop').style.display = 'none';
    };

    // --- INITIALIZATION & DIAGNOSTICS ---
    document.addEventListener('DOMContentLoaded', function() {
      const indicator = document.getElementById('status-indicator');
      const textarea = document.getElementById('md');
      const buttons = document.querySelectorAll('.btn');

      if (window.APP && APP.converter && typeof APP.converter.asBlob === 'function') {
        indicator.style.color = '#22c55e'; // Green
        indicator.title = 'Converter Ready';
        console.log('R² Solutions Converter v4.0 Initialized Successfully.');
      } else {
        indicator.style.color = '#ef4444'; // Red
        indicator.title = 'Converter FAILED to load!';
        console.error('FATAL: Converter library did not load. See error above.');
        textarea.value = 'CRITICAL ERROR:\n\nThe conversion library failed to load, so the tool is disabled. This is likely due to browser security restrictions or a script error.\n\nPlease check the browser\'s developer console for any errors and report them.';
        textarea.readOnly = true;
        buttons.forEach(btn => btn.disabled = true);
        APP.showToast('Error: Converter failed to load!');
      }
    });
  </script>
</body>
</html>
